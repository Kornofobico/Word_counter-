-- LocalScript: Contador de palavras do chat gravando em Workspace para o executor (cliente)
-- Coloque em: StarterPlayer > StarterPlayerScripts

local TextChatService = game:GetService("TextChatService")
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local TOP_N = 20 -- Quantas palavras mostrar na UI
local IGNORE_COMMANDS = true -- Ignora mensagens que comecem com '/'

-- Pasta em Workspace que irá conter os IntValues com as contagens
local folderName = "ChatWordCounts_" .. LocalPlayer.Name
local workspaceFolder = workspace:FindFirstChild(folderName)
if not workspaceFolder then
    workspaceFolder = Instance.new("Folder")
    workspaceFolder.Name = folderName
    workspaceFolder.Parent = workspace
end

-- Sanitiza token para uso como nome de Instance em Workspace:
-- - converte para lowercase
-- - remove espaços/ponctuação indesejada, substitui por underscore
-- - remove underscores duplicados nas bordas
local function sanitizeForName(word)
    if not word then return "unknown" end
    word = word:lower()
    word = word:match("^%s*(.-)%s*$") or word -- trim
    -- substitui tudo que não for letra/número/underscore por underscore
    word = word:gsub("[^%w]", "_")
    -- colapsa underscores múltiplos
    word = word:gsub("_+", "_")
    -- remove underscores nas bordas
    word = word:gsub("^_+", ""):gsub("_+$", "")
    if word == "" then
        return "unknown"
    end
    return word
end

-- Sanitização para contar (remove pontuação nos extremos, mantém acentos)
local function sanitizeToken(token)
    if not token then return "" end
    local w = token:lower()
    w = w:gsub("^%p+", ""):gsub("%p+$", "")
    w = w:match("^%s*(.-)%s*$") or w
    return w
end

-- Atualiza Workspace: incrementa IntValue existente ou cria novo com Value = 1
local function incrementWorkspaceCount(word)
    local name = sanitizeForName(word)
    local existing = workspaceFolder:FindFirstChild(name)
    if existing and existing:IsA("IntValue") then
        existing.Value = existing.Value + 1
    else
        local val = Instance.new("IntValue")
        val.Name = name
        val.Value = 1
        val.Parent = workspaceFolder

        -- opcional: guardar a forma "apresentável" da palavra original
        local display = Instance.new("StringValue")
        display.Name = "Display_" .. name
        display.Value = word:lower()
        display.Parent = val
    end
end

-- Retorna top N lendo diretamente dos IntValues dentro da pasta em Workspace
local function getTopFromWorkspace(n)
    local arr = {}
    for _, child in ipairs(workspaceFolder:GetChildren()) do
        if child:IsA("IntValue") then
            -- tenta pegar o display se existir
            local display = child:FindFirstChild("Display_" .. child.Name)
            local word = (display and display.Value) or child.Name
            table.insert(arr, {word = word, count = child.Value})
        end
    end
    table.sort(arr, function(a,b)
        if a.count == b.count then
            return a.word < b.word
        end
        return a.count > b.count
    end)
    local res = {}
    for i = 1, math.min(n, #arr) do
        table.insert(res, arr[i])
    end
    return res
end

-- UI simples (similar ao anterior) que mostra top N com base no Workspace
local function createUI()
    local screenGui = Instance.new("ScreenGui")
    screenGui.Name = "ChatWordCounterGUI"
    screenGui.ResetOnSpawn = false

    local frame = Instance.new("Frame")
    frame.Name = "Container"
    frame.Size = UDim2.new(0, 260, 0, 200)
    frame.Position = UDim2.new(1, -270, 0, 10)
    frame.BackgroundTransparency = 0.35
    frame.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
    frame.Parent = screenGui

    local title = Instance.new("TextLabel")
    title.Name = "Title"
    title.Size = UDim2.new(1, -10, 0, 24)
    title.Position = UDim2.new(0, 5, 0, 5)
    title.BackgroundTransparency = 1
    title.TextColor3 = Color3.fromRGB(255,255,255)
    title.Font = Enum.Font.SourceSansBold
    title.TextSize = 18
    title.TextXAlignment = Enum.TextXAlignment.Left
    title.Text = "Top palavras (Workspace)"
    title.Parent = frame

    local body = Instance.new("TextLabel")
    body.Name = "Body"
    body.Size = UDim2.new(1, -10, 1, -34)
    body.Position = UDim2.new(0, 5, 0, 30)
    body.BackgroundTransparency = 1
    body.TextColor3 = Color3.fromRGB(230,230,230)
    body.Font = Enum.Font.SourceSans
    body.TextSize = 16
    body.TextXAlignment = Enum.TextXAlignment.Left
    body.TextYAlignment = Enum.TextYAlignment.Top
    body.TextWrapped = true
    body.Text = ""
    body.Parent = frame

    screenGui.Parent = LocalPlayer:WaitForChild("PlayerGui")
    return body
end

local bodyLabel = createUI()

local function updateUI()
    local top = getTopFromWorkspace(TOP_N)
    if #top == 0 then
        bodyLabel.Text = "Nenhuma palavra registrada ainda."
        return
    end
    local lines = {}
    for i, item in ipairs(top) do
        table.insert(lines, string.format("%d. %s (%d)", i, item.word, item.count))
    end
    bodyLabel.Text = table.concat(lines, "\n")
end

-- Processa uma mensagem: tokeniza, sanitiza e incrementa no Workspace
local function processMessage(msg)
    if not msg or msg == "" then return end
    if IGNORE_COMMANDS and msg:sub(1,1) == "/" then return end

    for token in string.gmatch(msg, "%S+") do
        local w = sanitizeToken(token)
        if w ~= "" then
            incrementWorkspaceCount(w)
        end
    end
    updateUI()
end

-- Conecta ao TextChatService (novo sistema) ou fallback para LocalPlayer.Chatted
if TextChatService and TextChatService.OnIncomingMessage then
    TextChatService.OnIncomingMessage:Connect(function(textChatMessage)
        local text = textChatMessage.Text
        if text then
            processMessage(text)
        end
    end)
else
    warn("TextChatService.OnIncomingMessage não disponível; fallback ativo (apenas mensagens locais).")
    LocalPlayer.Chatted:Connect(function(msg)
        processMessage(msg)
    end)
end

-- Função pública para resetar contagens (apaga os IntValues)
local function resetCounts()
    for _, child in ipairs(workspaceFolder:GetChildren()) do
        child:Destroy()
    end
    updateUI()
end

-- Expõe reset no PlayerGui com um atributo de teste (opcional)
workspaceFolder:SetAttribute("Owner", LocalPlayer.Name)
-- Para chamar reset manualmente (ex.: no console) você pode rodar:
-- game.Workspace["ChatWordCounts_<SeuNome>"]:ClearAllChildren()  -- ou usar resetCounts dentro do LocalScript
